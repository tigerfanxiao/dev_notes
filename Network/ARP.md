
# 基本原理

ARP Address Resolution Protocol 地址解析协议. ARP 并不是 IP协议. 也就是说在二层帧的上面, 封装了 ARP 头部, 而不是 IPv4 头部. 
ARP 表描述的是 IP 地址和 MAC 地址之间的映射. 
一般情况下ARP Request 是由 PC 机发出的, 交换机收到后, 只是帮助泛洪. 交换机收到 ARP Response 之后也是通过查询 MAC 地址表来转发. 所以在交换机上并没有 ARP 表. 

ARP 头部的内容: 我的 IP 地址是多少, 对应的 MAC 地址是多少, 我请求如下 IP 地址对应的 MAC 地址. 

### 设备收到 ARP 请求后的行为
当主机知道对方的 ip 地址, 但是不知道对方的 mac 地址的时候, 就会发送 ARP request
请求的帧头部 源 mac 地址是自己网卡的 mac 地址, 目标 mac 地址是广播 mac 地址. 
1. 当交换机收到 ARP 请求时, 会学习帧头的源 mac 地址(PC 的 mac 地址和接收到帧的接口)存储到 MAC 地址表中. 并不修改帧的内容, 直接从其他接口泛洪出去.
2. 对端主机收到交换机泛洪的 arp 请求后. 发现ARP 头部中有自己的 IP 地址, 询问的是自己的 mac 地址, 会发送 ARP Response (单播). 单播的目的地址是 PC 的 mac 地址, 源是自己的 MAC 地址. 交换机收到 ARP Response 后, 通过查询自己的 MAC 地址表, 进行单播转发.  


### 区分 mac 表和 ARP 表 
* ARP 表是 mac 地址和 IP 地址的映射
* MAC 表是 mac 地址和接口的映射
总结
1. 如果是 2 层交换机, 在交换机上是没有ARP 表的
2.  ARP 缓存存在于 PC 端, 或者路由器上

### mac 地址老化的问题? 
一般主机的 ARP 表老化时间是 10-20 分钟, 比如 win10
现实中我的网络并非一成不变的, 老的设备走了, 新的设备进来. 要删除老的 mac 地址, 添加新的 mac 地址, 就需要没过一段时间去做一次免费的 arp 广播. 这个会造成几个问题

1. 广播报文的扩散问题. 从安全的角度看, 我希望做部门之间的隔离. 两个部门的终端接到同一台交换机之后, 他们会各自收到对方发来的免费广播, 知道对方的 mac 地址. 那么他们之间就可以通信. 
2. 从成本的角度看, 为了使两个部门互相不能通信, 我们就需要买两台交换机. 为了解决上面两个问题, 我们引入 [[VLAN]]这个技术


### ARP 类型
免费 ARP: 当终端设备修改和新设置 ip 地址的时候, 就会发送免费 ARP, 用来检测网络中是否有 IP 地址冲突
ARP Request
ARP Response

### ARP Proxy 代理
简单地说, 如果设备告诉一个广播域的其他设备, 用自己网卡的 mac 来响应非自己接口 IP 地址的请求, 就是代理 ARP
因为 ARP 请求是一个广播, 只能在广播域内传播, 在经过路由器的时候会被拦截. 
如果要把 ARP 请求传递出路由器, 需要将路由器设置为 ARP 代理.
此时当路由器收到一个 ARP 请求报文时, 发现其请求的 IP 地址不是自己, 则会进行如下操作
* 查询自己的路由, 如果有到目的地址的路由, 则把自己的 mac 地址发送给请求方
注意: 代理 ARP是一种能力, 思科设备默认在接口下是打开的. 但是很多防火墙的接口默认是不支持代理 ARP 的
# 在终端设备上查看 ARP 表

```shell
# 在 PC 上查看ARP表
arp -a 
# 清空 PC 上的 ARP 表
arp -d 
```