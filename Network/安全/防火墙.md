
# 概念
## 安全区域 Security Zone
防火墙的每一个接口属于不同的区域。 默认情况下， 防火墙有四个区域。 
1. local
2. trust
3. DMZ
4. untrust
防火墙默认每个区域之间是不通的， 所以防火墙的策略是区域间的策略



区域分类
注意: 在现在的防火墙中这些区域的优先级意义不大

| 区域       | 安全优先级 | 注释           |
| ---------- | ------ | -------------- |
| Local 本地 | 100    | 防火墙上的接口 |
| Trust      | 85     | 公司内网       |
| DMZ        | 50     | 公司服务器     |
| Untrust    | 5      | 外网           |

## 会话表

## 安全策略
基于 5 元组
- mac
- ip
- 协议号
- 端口号
- 用户, 时间
防火墙的动作
- 允许
- 拒绝
- 反馈/不反馈
- 流量清洗  面对重放攻击
- 防病毒
一般的配置方法, 先做全允许. 这样可以做测试. 否则按照默认的配置是全部拒绝的
后期再根据具体的需求, 再写策略
permit any any

条件
1. VLAN ID
2. 源安全区域
3. 目的安全区域
4. 源地址/地区
5. 目的地址/地区
6. 用户
7. 服务
8. 应用
9. URL 分类
10. 时间段
微信你发的图片都能知道

安全配置文件(看你购买的服务)
- 反病毒
- 入侵防御
- URL 过滤
- 文件过滤
- 内容过滤
- 应用行文过滤
- 邮件过滤
- APT 防御
- DNS 过滤



DMZ 区域不能访问 Trust 区域. 但是 Trust 区域可以访问 DMZ 区域
只有防火墙能做到这种单向的区域控制

### 企业对安全的诉求
1. 外部网络的安全隔离
2. 内部网络的安全隔离
3. 入侵防御
4. 内网的行为管理, 内容安全的过滤
5. 防病毒

windows防火墙说白了就是ACL, 允许了某些应用
入站和出站规则

华为的防火墙产品
USG6000V 系列: USG6525E-AC
USG9000V
IPS 入侵防御检测系统

防火墙比路由器和交换机都要贵

### 区分传统防火墙和下一代防火墙


### 防火墙的性能
防火墙可以对交换的报文进行安全检测, 包括数据链路, 网络, 甚至报文中的内容. 
因为要检查报文, 所以一般情况下要不影响网络速率, 防火墙的性能是要比交换机和路由器更高的

防火墙有个独特的硬件叫SPU Service Processing Unit
路由器里有个模块叫 LPU Line Processing Unit 包含 ACL规则, QoS策略, 流量管理

### 为什么允许外部访问的服务器要放在非DMZ中
公司内网的设备要访问外网一般是使用动态NAT. 这种情况下, 内网的地址外网是不可知的, 所以外网很难直接攻击某一台内网主机. 但是服务器的ip地址一般是用静态NAT的, 所以如果一旦被攻破, 变成肉鸡, 就很容易以服务器为根基, 攻击内容的主机所在的区域. 

在设计防火墙策略时, 一般不允许从DMZ区域直接访问内网主机所在区域. 这种策略只有防火墙能实现, 路由器和交换机无法实现. 

### 防火墙组网方式
1. 网络边界
2. 旁挂式组网. 可以提供安全增值服务(也称为安全联动), 让购买流量的用户流量经过防火墙 


### 划分区域

通过划分防火墙上的接口到某个区域, 实现将接口接到的设备划分区域
防火墙的策略是有方向的, 是区域间(Interzone)的策略


# 双机热备
区分设备出现故障
接口出现故障
TCP在开启状态检测之后, 只有首包建立会话表项 Session

用传统的VRRP, 就无法实现, 主备防火墙的状态一致性. 因为每一个vrrp都是独立的切换的. 如果是设备损坏, 里面和外面会一起切换master. 但是如果只有里面的链路断了, 里面切换了. 外面没有切换. 就会造成回去的路由, 找不到nat的session, 因为session是在坏了的master上创建的. 且TCP在开启状态检测之后, 就只有首包会建立会话表项. 从而造成丢包.

各大厂商都有自己的双机热备的私有协议和方案. 

华为的私有协议叫VGMP VRRP group management protocol. 可以将多个VRRP组管理起来. 一个组发生了切换, 其他的组也切换
VGMP的Active设备, 是所有管理的VRRP组的Master设备. VGMP的standby设备, 所有管理的VRRP组的Slave设备

Active和standby设备的默认优先级是45000, 如果发现VRRP备份组中有master设备切换了, Active设备就会把自己的优先级减1. 并通告给Standby设备. Standby设备会把所有的备份组的master都切换掉


HRP 协议, 也是华为的私有的数据备份协议:
包括设备信息备份, 命令行备份, 各种状态信息的备份. 通过这个协议, NAT的session就在主备设备上同步, NAT的转换表, IPSec的加解密信息

HRP协议可以看做VGMP协议的子协议



快速配置接口可以ping

```shell
interfaceg1/0/1.10
vlan-type dot1q 10
ip add 192.168.10.254 255.255.255.0
service-manage ping permit
```

NAT 配置
