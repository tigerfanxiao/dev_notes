# 背景

环路的本质是冗余. 生成树协议做两件事
1. 当有环路的时候, 发现阻塞的接口, 断开环路
2. 当链路故障的时候, 打开被阻塞的接口, 实现冗余链路的使用

连接服务器的接入层交换机, 就需要交换机的设备冗余的
个人 PC 连上接入层交换机, 一般不考虑设备冗余, 而是做链路冗余(成本也低)
设备冗余和链路冗余

堆叠 + Etrunk

mlag + Etrunk

### 广播风暴
BUM 帧 = Broadcast广播, U 未知单播帧, M 组播, 交换机在收到这种帧的时候, 会泛洪转发. 如果链路中有环路, 就会造成广播风暴. 此时链路的带宽会被沾满, 网络资源被耗尽, 其他的人会掉线.
解决方法:
1. 物理上拔线
2. 远程登录已经无法解决, 只能连接设备局的console口去配置

二层帧接口没有TTL, 无放环能力, 所以广播风暴会一直持续下去, 网卡会收到大量的广播帧, 网卡不但对这些网络帧做解封装, 带宽被占用. 也会导致在网络中的主机运行缓慢, 因为主机用 cpu 进行解封装.

### mac 地址漂移
因为环路的原因, 设备从左边的接口和右边的接口都收到单播帧, 所以mac的原地址会在两个接口之间漂移.
一般情况下, 如果发现mac地址漂移, 设备会告警. 


# 开启生成树

### 生成树的发波原理
1. 一开始所有的接口都能发波
2. 波和波之间进行比较
3. 当两个波比较好, 只有强的一方可以发波, 弱的接口只能接受BPDU
4. 那些强的接口接可以正常打开, 称为制定端口DP, 正常转发普通用户帧
5. 除了最强的设备(根桥, 每一个接口都在发波), 没一个非根桥上有且只有一个收波口正常打开, 这个端口也称为根端口RP
6. 如果发现一台设备有多个收波口, 就选择一个达到根桥开销RPC最小的接口作为RP, 剩下的接口阻塞

BPDU的发送是周期, 2秒发送一次. 谁先启动没关系
BPDU有超时时间, 默认是20秒, 华为优化为6秒
BPDU的目的mac地址是一个组播地址 01-80-C2-00-00-00

```shell
stp mode stp # 启用生成树
stp disable # 关闭生成树
```

步骤
1. 确定根桥
2. 接口的开销
3. 根路径开销 RPC Root Path Cost
4. Port ID 
5. BPDU 
6. RP Root Port 根端口
7. DP Designed Port 指定端口

### cost
每一个激活了生成树协议的端口都会计算一个开销值, 计算到达根路径的开销
总体来说带宽越大开销越小, 和双工模式, 端口聚合有关


默认的桥优先级是 32768. 桥优先级一般是 4096 的倍数
如果指定设备为根桥. 可以把桥优先级设置为 0
```shell
stp mode stp
stp prority 0
```


### 计算开销
1. 通过命令手动修改开销
2. 设备自行计算开销
开销有三种计算标准 
1. 802.1d-1998, 802.1t
2. 华为私有标准 
3. 思科的交换机默认的标准是 802.1d

```shell
# 修改开销标准
stp pathcost-standard dot1d  # 设置开销计算标准 802.1d
```

开销计算举例
100 兆全双工的端口 
* 802.1d = 18 
* 802.1t=20000 华为私有=199
1000 兆全双工的端口 
* 802.1d = 4
* 华为私有=20

因为开销值是作为链路的开销, 所以修改开销的时候, 要做到链路两遍都要改
dot1t = 802.1t

修改开销举例
```shell
int g0/0/1
stp cost 1000  # 修改开销值
stp port 100 # 修改接口优先级
```

在现网中, 所有交换机应该要确保使用相同的开销标准

根路径开销 Root Path Cost 简称 RPC
RPC等于从根桥到该设备沿途所有入方向接口的累加

### 端口ID Port ID 
运行生成树的交换机使用 port ID 来标识每个接口
端口 ID 主要在特定场景下. 注意是BPDU发送方的端口. 所以接收方的多个接口收到多个BPDU, 里面端口ID小的为根端口, 剩下的阻塞

端口ID计算公式
端口 ID = 4bit 端口优先级 + 12bit接口编号. 华为缺省的端口优先级是 128
g0/0/1 的端口编号就是 1, 此时端口ID = 128.1
但是在高端交换机(有多个板卡)可能出现 port id 冲突的情况, 需要到设备上去看

很少场景会用到PID来比较, 基本都是两台设备之间, 用两条平行链路连接时才会出现RID, BID都一样的情况

# BPDU  Bridge Protocal Data Unit
通过 802.3 的帧格式来发送. 
BPDU 分为两种
1. 配置 BPDU 完成生成树计算
2. TCN BPDU 拓扑改变通知, 只有在拓扑变化时才会产生
其中有4个参数是最重要的

配置BPDU 报文格式
1. PID 协议 ID, 对生成树而言, 总是 0
2. PVI 协议版本号, 对应生成树而言, 总是 0
3. BPDU Type: 有两种 0x00表示配置 BPDU, 0x80表示 TCN BPDU
4. Flags 8bit 生成树使用了最低和最高两个 bit 位. 最低位是 TC 表示拓扑变更, 最高位 TCA 表示拓扑变更确认
5. Router-ID 根桥的桥 ID
6. RPC Root Path Cost 根路径开销
7. Bridge ID 发送者的桥 ID, 4096 的倍数,范围在 0-61440
8. Port ID
9. Message Age 本质上是到达根的跳数
10. Max Age 默认是 20s
11. Hello Time 默认是 2s, 根桥发送 BPDU 的间隔
12. Forward Delay 转发延迟, 默认是 15s

根端口是非根桥去往根桥路径最优的端口. 
根端口是接受来自根桥最好 BPDU 的端口
根端口只在非根桥设备上, 且每台设备只有一个
根桥没有根端口

如果一个端口既不是根端口也不是指定端口, 则为预备端口alternative port, 预备端口会被阻塞

### 指定端口 Designed Port
在每条链路上选举一个指定端口. 
指定端口是用来转发最好的 BPDU 的端口
一般情况下, 根桥的所有端口都是指定端口


### STP 选举机制
1. 选择根桥, 全网 BID 最小的交换机为根桥, 具备抢夺性和唯一性
2. 除根桥外, 其他交换机为非根桥
3. 在每个非根桥上选举一个根端口
4. 在每一条链路上选举一个指定端口
5. 既不是非根桥的 RP, 也不是链路的 DP, 则这个端口为 block 端口

### 根桥选举
生成树协议 801.D 每台交换机都有桥 ID(Bridge ID或 BID), 在生成树网络中来标识不同的桥 ID, 在设备出厂的时候就有. 
桥ID最小的交换机为根桥. 
桥 ID = 16bit 桥优先级 (默认是32768)+ 桥MAC 地址 
桥 ID 最小的交换机就是根桥, 优先级相同 MAC 地址最小的称为根桥. 
根桥具备抢夺性

> 桥ID默认是32768, 修改的话必须是 4096的倍数

通过修改桥优先级为0, 别的设备默认是32768, 所以修改后,该设备为根桥
```shell
stp priority 0  
```

如何查看交换机的 BID
```shell
display stp # CIST Bridge, 每一个接口的开销值

```

### 什么是最好的 BPDU?
按照如下规则选择
1. 最小的根桥RID 8个字节
2. 最小的RPC 4 个字节
3. 最小的网桥 ID 8个字节
4. 最小的Port ID 2个字节
以上规则也称为 8482 

BPDU 转发
非根桥收到根桥发来的 BPDU 时, 会保留 RID, 换上自己的 BID,  计算累计 PRC, 然后再转发

在现网中, 可能会手动指定某一台设备的RID 为 0, 来保证后续进入网络的设备根桥不改变.
在稳定的生成树的网络中, 根端口负责接收根桥的 bpdu, 指定端口负责发送根桥的 BPDU
在连接主机的接口上, 因为不会从 PC 侧收到 BPDU, 所以自己的端口一定是指定端口. 在默认情况下会向 PC 发送 BPDU


标准生产树的状态
1. 禁用 
2. 阻塞
3. 监听
4. 学习
5. 转发

禁用(Disable): 该端口不收发BPDU, 也不能收发业务数据帧. 本质上是接口down的的状态
阻塞(blocking): 该接口被STP阻塞. 不能发送BPDU但是能监听BPDU. 不能发送数据帧, 也不会进行MAC地址的学习
侦听(Listening): STP初步认定该接口是制定端口或者根端口, 接口依然处于STP计算过程中. 在侦听状态有15秒, 也称为转发延迟
学习(Learning): 接口处于此状态时会侦听业务帧, 但是不转发. 但是收到业务帧后会学习. MAC地址. 这个时间也是15秒. 如果不学习MAC地址, 则在转发过程中就要发未知单播帧来寻找MAC地址. 为了减少网络中的广播报文, 就安排了学习MAC地址的步骤
转发(Forwarding): 正常转发业务帧, 也会处理BPDU

总结, 在普通的STP下, 进入转发状态需要30秒的时间. 也就是说, 如果链路发声中断, 如果不是中断链路两侧的设备, 则要等20s阻塞端口发现BPDU过期, 切换到新的链路需要30秒, 所以要50秒才能恢复
中断链路两侧的设备, 因为可以立刻发现链路中断, 所以无需等待BPDU过期的20秒

### MAC地址表变化问题
![[Pasted image 20230709101807.png]]

当图中右侧链路发生中断. 右侧下面的原来被block的端口会进入转发状态. 原本从R2-R1-R3的流量现在变为R1-R2-R3. 拓扑结构发生了变化.
但是BPDU的变化, 只能引起端口角色的变化, 不能引起MAC地址表的变化. 即原来block的端口被打开. 但是R2上的MAC地址表不能响应拓扑结构的变化. 
因为R3上方的链路中断, 而每一台交换机必须有一个根端口, 所以原先被阻塞的端口转变为根端口, 接受BPDU, 并不能发出BPDU. 而R2是通过收到的帧的源地址来学习MAC地址的. R2因为无法从R3收到BPDU, 原先的MAC地址表不会发生变化. 因为原先R3的mac地址应该是从g0/0/1接口学到的,, 原先的转发路径是R2-R1-R3. R2的MAC地址表不变, 但是R2-R3的链路已经中断, 会造成R2-R3无法通信.
此时需要被阻塞的设备R3会打开原来的阻塞端口, 变为根端口. 并从根端口主动发送TCN BPDU (Topology Change Notification). R2在收到TCN后会沿着根端口的方向转发TCN 到根桥R1. 根桥R1会下发TC到网络中的其他设备, 通知大家拓扑发生了变化. R2在收到R1发出的TC后, 会把R3的MAC地址对应的端口从MAC地址表中删除. 此时因为R3对应的接口被删除, R2向R3发送BPDU时就会重新发送未知单播帧, 这个帧会泛洪. 最后R2会从新的接口学到R3的MAC地址


### 现网设计
接入层交换机会与两台主备核心层交换机互联,  构建从接入到核心的链路冗余. 这种拓扑结构会形成环路. 在这种拓扑设计下, 一般是阻塞接入层交换机的口, 以切断环路. 
两台核心交换机之间的链路不能阻断, 是因为这两台链路可以做心跳. 以确保备份核心不下线. 
接入和核心之间的链路为什么阻断接入侧的接口而不是核心侧的接口?
如果左侧的接入到核心链路中断, 接入层交换机会立刻发现, 免去了20秒的阻塞到监听的等待时间. 但如果阻塞的是核心一侧的接口, 右侧的核心交换机并不能马上发现链路的中断, 则需要多等待20秒的时间等收到的BPDU过期, 才能进入监听状态.


![[Pasted image 20230709095426.png]]



命令
```shell

undo stp enable # 华为 关闭生成树
```


常见的生成树协议
RSTP 快速生成树
MSTP 多实例生成树
